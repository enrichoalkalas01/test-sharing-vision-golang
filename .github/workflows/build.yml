name: Go Application CI/CD

on:
    push:
        branches: ["main", "master"]
    pull_request:
        branches: ["main", "master"]

env:
    IMAGE_NAME: "go-app"
    GO_VERSION: "1.22"
    REGISTRY: ${{ vars.REGISTRY }}
    REGISTRY_PROJECT: ${{ vars.REGISTRY_PROJECT }}

jobs:
    # Build & Test
    build-and-test:
        runs-on: self-hosted

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Download Go Dependencies
              run: go mod download

            - name: Run Go Lint
              continue-on-error: true
              run: |
                  go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
                  golangci-lint run ./... || echo "⚠️ Linting completed with warnings"

            - name: Run Tests
              continue-on-error: true
              run: go test -v -race -coverprofile=coverage.out ./...

            - name: Build Go Binary
              run: |
                  go build -o app -ldflags="-w -s" .

    # Build & Push Docker Image
    docker-build-push:
        runs-on: self-hosted
        needs: build-and-test
        if: github.event_name == 'push'

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Buildx Config for Harbor
              run: |
                  mkdir -p ~/.config/buildkit

                  cat > ~/.config/buildkit/buildkitd.toml <<'EOF'
                  debug = true

                  [registry."${{ env.REGISTRY }}"]
                    http = false
                    insecure = true
                  EOF

                  echo "✅ Buildkit config created for Harbor registry"
                  cat ~/.config/buildkit/buildkitd.toml

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
              with:
                  driver-opts: network=host
                  buildkitd-config: /home/enrichoalkalas06/.config/buildkit/buildkitd.toml

            - name: Login to Harbor Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ secrets.REGISTRY_USERNAME }}
                  password: ${{ secrets.REGISTRY_PASSWORD }}

            - name: Build and Push
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:latest
                      ${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  network: host

    # Deployment Instructions
    deployment-info:
        runs-on: self-hosted
        needs: docker-build-push
        if: success()

        steps:
            - name: Generate Summary
              run: |
                  echo "## ✅ Build Success!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Image:** \`${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**SHA Tag:** \`${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Deploy Command:" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
                  echo "docker run -d -p 8080:8080 --name ${{ env.IMAGE_NAME }} \\" >> $GITHUB_STEP_SUMMARY
                  echo "  ${{ env.REGISTRY }}/${{ env.REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
